import { readFile, readFileSync, writeFile } from 'node:fs';
import { dirname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import type { Options } from 'prettier';
import { format } from 'prettier';
import options from '../.prettierrc.cjs';

const __dirname = dirname(fileURLToPath(import.meta.url));

const rootPath = resolve(__dirname, '..');
const mimeDbPath = resolve(rootPath, 'node_modules/mime-db/db.json');
const mimeDbLicensePath = resolve(rootPath, 'node_modules/mime-db/LICENSE');
const mimeTypesTsPath = resolve(rootPath, 'src/locales/en/system/mimeTypes.ts');
const prettierTsOptions: Options = { ...options, parser: 'typescript' };
readFile(mimeDbPath, 'utf8', (err, data) => {
  if (err) {
    throw err;
  }

  const license = readFileSync(mimeDbLicensePath, { encoding: 'utf8' });
  const mimeTypeFileContent = `// This file is generated by scripts/copyMimeTypes.ts\n// Do not edit this file directly. Instead, update mime-db and run \`pnpm run copy:mime-types\`\n\n/*\n${license}*/\n\nexport default ${data};\n`;

  writeFile(
    mimeTypesTsPath,
    format(mimeTypeFileContent, prettierTsOptions),
    (err) => {
      if (err) {
        throw err;
      }

      console.log(`Mime types copied to ${mimeTypesTsPath}`);
    }
  );
});
